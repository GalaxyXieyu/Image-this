# 并发控制说明

## 概述

为了避免 API 并发限制和网络连接问题，系统实现了多层并发控制机制。

## 并发控制层级

### 1. Worker 批量处理层（最多 3 个并发）

**位置**: `src/app/api/tasks/worker/route.ts`

**实现**: 使用滑动窗口算法控制并发

```typescript
// 限制并发处理任务（最多同时3个）
const results = await this.processConcurrently(
  pendingTasks,
  (task: any) => this.processSingleTask(task),
  3 // 最大并发数
);
```

**工作原理**:
- 从任务队列获取待处理任务
- 使用 `processConcurrently` 方法限制同时执行的任务数
- 当有 3 个任务在执行时，等待其中一个完成后再启动下一个
- 避免同时发起过多 API 请求

**日志输出示例**:
```
[并发控制] 开始处理 6 个任务，最大并发数: 3
[并发控制] 达到并发限制 (3)，等待任务完成...
[并发控制] 任务完成 (1/6)，当前并发: 2
[并发控制] 任务完成 (2/6)，当前并发: 2
[并发控制] 等待剩余 1 个任务完成...
[并发控制] 所有任务处理完成
```

### 2. 即梦 API 层（重试机制）

**位置**: `src/app/api/jimeng/service.ts`

**特性**:
- 最多重试 3 次
- 指数退避策略（2s → 4s → 8s，最多 10s）
- 特殊处理并发限制错误（code=50430）
- 串行上传参考图片，避免并发上传导致的连接问题

**错误处理**:
```typescript
// 检查是否是并发限制错误
if (result.code === 50430) {
  throw new Error(`CONCURRENT_LIMIT:${result.message || 'API并发限制'}`);
}
```

### 3. Superbed 图床层（重试机制）

**位置**: `src/lib/superbed-upload.ts`

**特性**:
- 最多重试 3 次
- 指数退避策略（1s → 2s → 4s，最多 5s）
- 智能判断可重试错误（ECONNRESET、ETIMEDOUT、429、503、504）
- 30 秒超时保护

**可重试错误**:
- `ECONNRESET`: 连接被重置
- `ETIMEDOUT`: 连接超时
- `ECONNREFUSED`: 连接被拒绝
- `429`: 请求过多
- `503`: 服务不可用
- `504`: 网关超时

## 并发控制效果

### 场景 1: 批量处理 10 个任务

**之前**:
```
同时发起 10 个 API 请求 → 触发并发限制 → 全部失败
```

**现在**:
```
第1批: 3个任务并发执行
第2批: 等待第1批完成后，启动3个新任务
第3批: 等待第2批完成后，启动3个新任务
第4批: 等待第3批完成后，启动1个新任务
结果: 稳定完成，避免并发限制
```

### 场景 2: 网络波动导致连接失败

**之前**:
```
上传失败 (ECONNRESET) → 任务失败
```

**现在**:
```
第1次尝试: 失败 (ECONNRESET)
等待 1 秒...
第2次尝试: 失败 (ECONNRESET)
等待 2 秒...
第3次尝试: 成功 ✓
```

### 场景 3: API 并发限制

**之前**:
```
API 调用失败 (code=50430) → 任务失败
```

**现在**:
```
第1次尝试: 失败 (并发限制)
等待 2 秒...
第2次尝试: 失败 (并发限制)
等待 4 秒...
第3次尝试: 成功 ✓
```

## 配置参数

### Worker 并发数
```typescript
// src/app/api/tasks/worker/route.ts
const concurrency = 3; // 最大并发数
```

### 即梦 API 重试
```typescript
// src/app/api/jimeng/service.ts
maxRetries = 3  // 最多重试3次
delay = 2s → 4s → 8s (最多10s)
```

### Superbed 重试
```typescript
// src/lib/superbed-upload.ts
retries = 3  // 最多重试3次
delay = 1s → 2s → 4s (最多5s)
timeout = 30s
```

## 监控和调试

### 查看并发控制日志
```bash
# 启动开发服务器
npm run dev

# 查看日志
tail -f logs/app.log | grep "并发控制"
```

### 关键日志标识
- `[并发控制]`: Worker 层并发控制
- `[即梦API]`: 即梦 API 调用和重试
- `[Superbed]`: 图床上传和重试

## 最佳实践

1. **批量任务**: 建议每批不超过 10 个任务
2. **并发数**: 保持在 3 个以内，避免触发 API 限制
3. **重试策略**: 使用指数退避，避免立即重试加重服务压力
4. **错误处理**: 区分可重试和不可重试错误
5. **超时设置**: 合理设置超时时间，避免长时间等待

## 性能影响

### 吞吐量
- **理论**: 3 个并发 × 平均 30 秒/任务 = 6 任务/分钟
- **实际**: 考虑重试和网络延迟，约 4-5 任务/分钟

### 资源占用
- **内存**: 每个任务约 50-100MB（图片处理）
- **CPU**: 主要在图片编码/解码时使用
- **网络**: 上传/下载带宽取决于图片大小

## 故障排查

### 问题 1: 所有任务都失败
**可能原因**: API 配置错误或服务不可用
**解决方案**: 检查环境变量和 API 密钥

### 问题 2: 任务处理很慢
**可能原因**: 网络延迟或 API 响应慢
**解决方案**: 检查网络连接，考虑增加超时时间

### 问题 3: 频繁触发重试
**可能原因**: 网络不稳定或 API 限制
**解决方案**: 减少并发数，增加重试延迟

## 未来优化

1. **动态并发控制**: 根据 API 响应时间自动调整并发数
2. **优先级队列**: 高优先级任务优先处理
3. **断点续传**: 大文件上传支持断点续传
4. **缓存机制**: 缓存常用的处理结果
5. **负载均衡**: 多个 API 密钥轮询使用
